version: '3.8'

services:
  # Infrastructure
  postgres:
    image: postgres:15-alpine
    command: [ "postgres", "-c", "max_connections=500" ]
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5433:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d postgres" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS}
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 15s
      timeout: 30s
      retries: 5

  redis:
    image: redis:alpine
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb:
    image: mongo:latest
    volumes:
      - mongodb_data:/data/db

  # API Gateway (Nginx)
  nginx-gateway:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - user-service
      - product-management
      - cart-service
      - docs-service

  # Documentation Sidecar (Internal)
  docs-service:
    build: ./docs_service
    environment:
      - USER_SERVICE_URL=http://user-service:8002
      - PRODUCT_SERVICE_URL=http://product-management:8000
      - CART_SERVICE_URL=http://cart-service:8001
    depends_on:
      - user-service
      - product-management
      - cart-service

  # Services (Internal only)
  order-service:
    build: ./order_service
    environment:
      - PORT=50051
      - DATABASE_URL=${ORDER_DATABASE_URL}
      - RABBITMQ_URL=${ORDER_RABBITMQ_URL}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  cart-service:
    build: ./cart_service
    environment:
      - PORT=8001
      - REDIS_HOST=${CART_REDIS_HOST}
      - REDIS_PORT=${CART_REDIS_PORT}
      - ORDER_SERVICE_URL=${CART_ORDER_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - redis
      - order-service

  user-service:
    build: ./user_service
    environment:
      - PORT=8002
      - MONGODB_URI=${USER_MONGODB_URI}
      - JWT_SECRET=${JWT_SECRET}
      - REFRESH_SECRET=${REFRESH_SECRET}
    depends_on:
      - mongodb

  product-management:
    build: ./product_management
    environment:
      - PORT=8000
      - DB_HOST=${PRODUCT_DB_HOST}
      - DB_PORT=${PRODUCT_DB_PORT}
      - DB_USER=${PRODUCT_DB_USER}
      - DB_PASSWORD=${PRODUCT_DB_PASSWORD}
      - DB_NAME=${PRODUCT_DB_NAME}
      - RABBITMQ_URL=${PRODUCT_RABBITMQ_URL}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  payment-service:
    build: ./payment_service
    environment:
      - RABBITMQ_URL=${ORDER_RABBITMQ_URL}
    depends_on:
      rabbitmq:
        condition: service_healthy

  delivery-service:
    build: ./delivery_service
    environment:
      - RABBITMQ_URL=${ORDER_RABBITMQ_URL}
    depends_on:
      rabbitmq:
        condition: service_healthy

volumes:
  postgres_data:
  mongodb_data:
